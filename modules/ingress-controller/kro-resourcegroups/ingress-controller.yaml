apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: ingress-controller
spec:
  schema:
    apiVersion: v1alpha1
    kind: IngressController
    group: ingress.company.com
    spec:
      # Cluster Configuration
      clusterName: string | required=true
      region: string | required=true
      accountID: string | required=true

      # Controller Configuration
      controllerNamespace: string | default="kube-system"
      controllerType: string | default="aws-load-balancer"  # aws-load-balancer or nginx
      vpcID: string | required=true

      # AWS Load Balancer Controller Configuration
      enableWAFv2: boolean | default=false
      enableShield: boolean | default=false
      enableCognito: boolean | default=false

      # Default IngressClass Configuration
      defaultIngressClass: string | default="alb"
      createInternalIngressClass: boolean | default=true
      createExternalIngressClass: boolean | default=true

      # Resource Configuration
      replicas: integer | default=2
      cpuRequest: string | default="100m"
      memoryRequest: string | default="256Mi"
      cpuLimit: string | default="500m"
      memoryLimit: string | default="1Gi"

  resources:
    # Namespace
    - id: controllerNamespace
      template:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: ${schema.spec.controllerNamespace}
          labels:
            app.kubernetes.io/name: aws-load-balancer-controller

    # ServiceAccount
    - id: controllerServiceAccount
      template:
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: aws-load-balancer-controller
          namespace: ${schema.spec.controllerNamespace}
          labels:
            app.kubernetes.io/name: aws-load-balancer-controller

    # IAM Policy
    - id: controllerIAMPolicy
      template:
        apiVersion: iam.services.k8s.aws/v1alpha1
        kind: Policy
        metadata:
          name: aws-load-balancer-controller-policy
          namespace: ${schema.spec.controllerNamespace}
        spec:
          name: "${schema.spec.clusterName}-aws-load-balancer-controller"
          description: "IAM policy for AWS Load Balancer Controller"
          policyDocument: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "iam:CreateServiceLinkedRole"
                  ],
                  "Resource": "*",
                  "Condition": {
                    "StringEquals": {
                      "iam:AWSServiceName": "elasticloadbalancing.amazonaws.com"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:DescribeAccountAttributes",
                    "ec2:DescribeAddresses",
                    "ec2:DescribeAvailabilityZones",
                    "ec2:DescribeInternetGateways",
                    "ec2:DescribeVpcs",
                    "ec2:DescribeVpcPeeringConnections",
                    "ec2:DescribeSubnets",
                    "ec2:DescribeSecurityGroups",
                    "ec2:DescribeInstances",
                    "ec2:DescribeNetworkInterfaces",
                    "ec2:DescribeTags",
                    "ec2:GetCoipPoolUsage",
                    "ec2:DescribeCoipPools",
                    "elasticloadbalancing:DescribeLoadBalancers",
                    "elasticloadbalancing:DescribeLoadBalancerAttributes",
                    "elasticloadbalancing:DescribeListeners",
                    "elasticloadbalancing:DescribeListenerCertificates",
                    "elasticloadbalancing:DescribeSSLPolicies",
                    "elasticloadbalancing:DescribeRules",
                    "elasticloadbalancing:DescribeTargetGroups",
                    "elasticloadbalancing:DescribeTargetGroupAttributes",
                    "elasticloadbalancing:DescribeTargetHealth",
                    "elasticloadbalancing:DescribeTags"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cognito-idp:DescribeUserPoolClient",
                    "acm:ListCertificates",
                    "acm:DescribeCertificate",
                    "iam:ListServerCertificates",
                    "iam:GetServerCertificate",
                    "waf-regional:GetWebACL",
                    "waf-regional:GetWebACLForResource",
                    "waf-regional:AssociateWebACL",
                    "waf-regional:DisassociateWebACL",
                    "wafv2:GetWebACL",
                    "wafv2:GetWebACLForResource",
                    "wafv2:AssociateWebACL",
                    "wafv2:DisassociateWebACL",
                    "shield:GetSubscriptionState",
                    "shield:DescribeProtection",
                    "shield:CreateProtection",
                    "shield:DeleteProtection"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:AuthorizeSecurityGroupIngress",
                    "ec2:RevokeSecurityGroupIngress",
                    "ec2:CreateSecurityGroup",
                    "ec2:CreateTags"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:CreateTags",
                    "ec2:DeleteTags"
                  ],
                  "Resource": "arn:aws:ec2:*:*:security-group/*",
                  "Condition": {
                    "StringEquals": {
                      "ec2:CreateAction": "CreateSecurityGroup"
                    },
                    "Null": {
                      "aws:RequestTag/elbv2.k8s.aws/cluster": "false"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "elasticloadbalancing:CreateLoadBalancer",
                    "elasticloadbalancing:CreateTargetGroup"
                  ],
                  "Resource": "*",
                  "Condition": {
                    "Null": {
                      "aws:RequestTag/elbv2.k8s.aws/cluster": "false"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "elasticloadbalancing:CreateListener",
                    "elasticloadbalancing:DeleteListener",
                    "elasticloadbalancing:CreateRule",
                    "elasticloadbalancing:DeleteRule",
                    "elasticloadbalancing:AddTags",
                    "elasticloadbalancing:RemoveTags",
                    "elasticloadbalancing:ModifyLoadBalancerAttributes",
                    "elasticloadbalancing:SetIpAddressType",
                    "elasticloadbalancing:SetSecurityGroups",
                    "elasticloadbalancing:SetSubnets",
                    "elasticloadbalancing:DeleteLoadBalancer",
                    "elasticloadbalancing:ModifyTargetGroup",
                    "elasticloadbalancing:ModifyTargetGroupAttributes",
                    "elasticloadbalancing:DeleteTargetGroup",
                    "elasticloadbalancing:RegisterTargets",
                    "elasticloadbalancing:DeregisterTargets",
                    "elasticloadbalancing:SetWebAcl",
                    "elasticloadbalancing:ModifyListener",
                    "elasticloadbalancing:AddListenerCertificates",
                    "elasticloadbalancing:RemoveListenerCertificates",
                    "elasticloadbalancing:ModifyRule"
                  ],
                  "Resource": "*"
                }
              ]
            }

    # IAM Role
    - id: controllerIAMRole
      template:
        apiVersion: iam.services.k8s.aws/v1alpha1
        kind: Role
        metadata:
          name: aws-load-balancer-controller-role
          namespace: ${schema.spec.controllerNamespace}
        spec:
          name: "${schema.spec.clusterName}-aws-load-balancer-controller"
          description: "IAM role for AWS Load Balancer Controller"
          assumeRolePolicyDocument: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Service": "pods.eks.amazonaws.com"
                  },
                  "Action": ["sts:AssumeRole", "sts:TagSession"]
                }
              ]
            }
          policies:
            - "$resource: controllerIAMPolicy.status.arn"

    # Pod Identity Association
    - id: controllerPodIdentity
      template:
        apiVersion: eks.services.k8s.aws/v1alpha1
        kind: PodIdentityAssociation
        metadata:
          name: aws-load-balancer-controller-identity
          namespace: ${schema.spec.controllerNamespace}
        spec:
          clusterName: ${schema.spec.clusterName}
          namespace: ${schema.spec.controllerNamespace}
          serviceAccount: aws-load-balancer-controller
          roleARN: "$resource: controllerIAMRole.status.ackResourceMetadata.arn"

    # Deployment
    - id: controllerDeployment
      template:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: aws-load-balancer-controller
          namespace: ${schema.spec.controllerNamespace}
          labels:
            app.kubernetes.io/name: aws-load-balancer-controller
        spec:
          replicas: 2
          selector:
            matchLabels:
              app.kubernetes.io/name: aws-load-balancer-controller
          template:
            metadata:
              labels:
                app.kubernetes.io/name: aws-load-balancer-controller
            spec:
              serviceAccountName: aws-load-balancer-controller
              securityContext:
                fsGroup: 65534
              containers:
                - name: controller
                  image: public.ecr.aws/eks/aws-load-balancer-controller:v2.7.0
                  args:
                    - --cluster-name=${schema.spec.clusterName}
                    - --ingress-class=${schema.spec.defaultIngressClass}
                    - --aws-region=${schema.spec.region}
                    - --aws-vpc-id=${schema.spec.vpcID}
                    - --enable-waf=false
                    - --enable-shield=false
                  resources:
                    requests:
                      cpu: ${schema.spec.cpuRequest}
                      memory: ${schema.spec.memoryRequest}
                    limits:
                      cpu: ${schema.spec.cpuLimit}
                      memory: ${schema.spec.memoryLimit}
                  securityContext:
                    allowPrivilegeEscalation: false
                    readOnlyRootFilesystem: true
                    runAsNonRoot: true
                    capabilities:
                      drop: ["ALL"]
              terminationGracePeriodSeconds: 10

    # Service
    - id: controllerService
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: aws-load-balancer-controller-webhook
          namespace: ${schema.spec.controllerNamespace}
        spec:
          ports:
            - port: 443
              targetPort: 9443
              protocol: TCP
          selector:
            app.kubernetes.io/name: aws-load-balancer-controller

    # IngressClass - External ALB
    - id: ingressClassExternal
      template:
        apiVersion: networking.k8s.io/v1
        kind: IngressClass
        metadata:
          name: alb-external
          labels:
            app.kubernetes.io/name: aws-load-balancer-controller
        spec:
          controller: ingress.k8s.aws/alb
          parameters:
            apiGroup: elbv2.k8s.aws
            kind: IngressClassParams
            name: alb-external-params

    # IngressClass - Internal ALB
    - id: ingressClassInternal
      template:
        apiVersion: networking.k8s.io/v1
        kind: IngressClass
        metadata:
          name: alb-internal
          labels:
            app.kubernetes.io/name: aws-load-balancer-controller
        spec:
          controller: ingress.k8s.aws/alb
          parameters:
            apiGroup: elbv2.k8s.aws
            kind: IngressClassParams
            name: alb-internal-params
